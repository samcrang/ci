#!/usr/bin/env bash
set -e

usage() {
  echo "CI 0.0.1"
  echo "usage: $0 <directory>"
}

teardown() {
  project="$1"

  if [ -f "$project/teardown.sh" ]; then
    bash "$project/teardown.sh"
  fi
}

setup() {
  project="$1"

  if [ -f "$project/setup.sh" ]; then
    bash "$project/setup.sh"
  fi
}

run_project() {
  project="$1"

  if [ -f "$project/run.sh" ]; then
    setup "$project"
    set +e
    bash "$project/run.sh" 
    status=$?
    set -e
    teardown "$project"
  else
    echo "Cannot find run.sh"
    status=1
  fi
}

subcommand="$1"
case "$subcommand" in 
  run)
    project="$2"

    if [ -z "$project" ]; then
      usage
      exit 1
    fi

    if [ -d "$project" ]; then
      run_project "$project"
    else 
      echo "Directory '$project' does not exist."
      status=1
    fi
    ;;

  init)
      directory="$2"

      if [ -z "$directory" ]; then
        usage
        exit 1
      fi

      if [ -d "$directory" ]; then
        scripts=( setup run teardown ) 
        for file in "${scripts[@]}"; do
          if [ ! -f "$directory/$file.sh" ]; then
            echo "#!/usr/bin/env bash" > "$directory/$file.sh"
          fi
        done
        exit 0
      else
        echo "Directory '$directory' does not exist."
        exit 1
      fi
    ;;
  *)
    usage
    exit 1
    ;;
esac

if [ "$status" -eq 0 ]; then
  echo "SUCCESS"
  exit 0
else
  echo "FAILURE"
  exit 1
fi
